# Multi-Family Feature - Implementation Context

This document provides a consolidated technical reference for implementing two major features: the **Setup Wizard Updates** and the **Family Management Page**. It details the architecture, file relationships, and core concepts that underpin the multi-family capabilities of the application.

## 1. Core Architectural Concepts

-   **Dual Authentication Systems**: The application will maintain two separate and parallel authentication systems:
    1.  **Standard User Auth**: The existing JWT-based system for regular users and family admins. It is **family-scoped**, meaning the JWT contains a `familyId` that restricts all API calls to that specific family's data. This is the default operational mode.
    2.  **Super Admin Auth**: A new, more secure system for a global administrator. It uses a separate login flow (email/password), a distinct `SuperAdmin` database table, a different JWT signing secret, and results in a **globally-scoped** JWT with no `familyId`. This token grants access to cross-family management APIs.

-   **Data Isolation by Design**: The `SuperAdmin` credentials are intentionally stored in a database table that has **no relations** to any other table (like `Family` or `Caretaker`). This ensures that backups of family data will never contain these high-privilege credentials, enhancing security.

-   **Explicit Privilege Escalation (The "Airlock")**: A user with super admin credentials does not have global powers by default. They must explicitly log in through the separate management portal's login screen to obtain the short-lived, globally-scoped JWT. This session is isolated to the management page itself.

-   **Dual-Mode Setup Wizard**: The Setup Wizard will operate in two distinct modes:
    1.  **Fresh Install Mode**: Automatically runs on the root page (`/`) if the database is completely empty.
    2.  **Invitation Mode**: Runs when a user visits a special, non-guessable URL (`/setup/[token]`) generated by an existing administrator.

---

## 2. Key Files & Components Reference

This section details the purpose and relationships of the key files involved in these features.

### 2.1. Infrastructure & Database

-   **File**: `.env`
    -   **Purpose**: Stores environment variables.
    -   **Relevance**: It will be updated by the setup script to include the new `SUPER_ADMIN_SECRET`, which is used to sign and verify the globally-scoped JWTs for the management page.

-   **File**: `scripts/setup.sh`
    -   **Purpose**: The primary initial setup script for the application.
    -   **Relevance**: It will be modified to:
        1.  Generate the `SUPER_ADMIN_SECRET` and add it to `.env`.
        2.  Interactively prompt for the super admin's email and password in the terminal.
        3.  Call the new `prisma/seedSuperAdmin.ts` script to create the first super admin.

-   **File**: `prisma/schema.prisma`
    -   **Purpose**: The single source of truth for the database schema.
    -   **Relevance**: It will be updated with two new models:
        -   `SuperAdmin`: A standalone table to store hashed super admin credentials, isolated from all other data.
        -   `FamilySetup`: A table to track the creation of new families via invitation links, storing a unique token and its expiration.

-   **File**: `prisma/seedSuperAdmin.ts` **(New)**
    -   **Purpose**: To create the initial super admin user.
    -   **Relevance**: This script is called by `setup.sh`. It will receive the email/password, hash the password using `bcrypt`, and create the record in the `SuperAdmin` table.

### 2.2. API Layer

-   **Location**: `app/api/utils/auth.ts`
    -   **Purpose**: Contains authentication utilities and middleware.
    -   **Relevance**: A new middleware, `withSuperAdminAuth`, will be added here. It will protect all routes under `/api/manage/*` by verifying the JWT signature against the `SUPER_ADMIN_SECRET`.

-   **Route**: `POST /api/auth/super/login` **(New)**
    -   **Purpose**: The login endpoint for the Family Management page.
    -   **Relevance**: It takes an email and password, verifies them against the `SuperAdmin` table, and issues the globally-scoped super admin JWT.

-   **Route**: `POST /api/setup/start` **(New)**
    -   **Purpose**: The core endpoint for the Setup Wizard.
    -   **Relevance**: Handles both "Fresh Install" and "Invitation" modes. It validates the request, creates the `Family` and its associated default `Settings` and `Units`, and returns the new family's ID.

-   **Route**: `POST /api/family/create-setup-link` **(New)**
    -   **Purpose**: Allows an existing admin to generate an invitation link for a new family.
    -   **Relevance**: Protected by `withAdminAuth` (the standard one). It creates a record in the `FamilySetup` table and returns the unique setup URL.

-   **Namespace**: `app/api/manage/*` **(New)**
    -   **Purpose**: A new set of API routes for all cross-family management operations.
    -   **Relevance**: Will include routes like `GET /api/manage/families`. All routes here will be protected by the `withSuperAdminAuth` middleware.

### 2.3. Frontend: Pages & Components

-   **File**: `app/(app)/[slug]/layout.tsx`
    -   **Purpose**: The main layout for the logged-in, family-scoped application.
    -   **Relevance**: The logic here (or on `app/page.tsx`) will be updated to detect a fresh install (e.g., by calling a status API) and conditionally render the `<SetupWizard />` instead of the main app content.

-   **Route**: `app/setup/[token]/page.tsx` **(New)**
    -   **Purpose**: A dynamic page to handle family setup via invitation links.
    -   **Relevance**: It extracts the `token` from the URL and renders the `<SetupWizard token={token} />` component.

-   **Component**: `src/components/SetupWizard/`
    -   **Purpose**: Guides users through the initial setup.
    -   **Relevance**:
        -   `index.tsx`: Will be updated to accept an optional `token` prop and call the `/api/setup/start` endpoint.
        -   `FamilySetupStage.tsx`: Will be updated with an input field for the user to customize their family's URL slug.
        -   `setup-wizard.types.ts`: Will be updated with the new props.

-   **Route**: `app/(manage)/manage-families/page.tsx` **(New)**
    -   **Purpose**: The entry point for the super admin management portal.
    -   **Relevance**: It will render the main `<FamilyManagement />` component.

-   **File**: `app/(manage)/layout.tsx` **(New)**
    -   **Purpose**: A simplified layout for the management section.
    -   **Relevance**: It will be a clean shell without the providers and UI elements specific to the user-facing application (e.g., `BabyProvider`, side nav), ensuring a clean separation of concerns.

-   **Component**: `src/components/FamilyManagement/` **(New)**
    -   **Purpose**: A new, self-contained set of components for the management UI.
    -   **Relevance**: It will follow the existing modular patterns (`index.tsx`, `*.styles.ts`, `*.css`, `*.types.ts`, `README.md`). It will contain the `Login.tsx` "airlock" component and the `Dashboard.tsx` to display and manage family data. It will use the application's global styles from `globals.css` for a consistent look and feel. 